<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sphere - Smart Investment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-gradient { background: linear-gradient(to right, #2563eb, #1d4ed8); }
        .btn-gradient:hover { background: linear-gradient(to right, #1d4ed8, #1e40af); }
        .success-anim { animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        
        @keyframes bounceIn {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .copy-success {
            background-color: #22c55e !important;
            color: white !important;
            animation: bounceIn 0.3s ease-in-out;
        }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="glass p-4 sticky top-0 z-50 border-b border-gray-800">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-500 tracking-wider">SPHERE</h1>
            
            <div id="auth-buttons">
                <button onclick="login()" class="bg-white text-black px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition flex items-center gap-2 text-sm">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Login
                </button>
            </div>

            <div id="user-menu" class="hidden flex items-center gap-3">
                <span class="text-sm text-gray-300 font-mono hidden md:block" id="username">...</span>
                <button onclick="openHistoryModal()" class="bg-gray-700 hover:bg-gray-600 text-blue-300 px-3 py-2 rounded-lg transition" title="History">
                    <i class="fas fa-history"></i>
                </button>
                <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-3 py-2 rounded-lg transition" title="Logout">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- LANDING PAGE -->
    <div id="landing-page" class="flex-grow">
        <div class="text-center p-10 py-20 bg-gradient-to-b from-gray-900 to-[#0f172a]">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">Earn with <span class="text-blue-500">Sphere</span></h1>
            <p class="text-gray-400 mb-8 max-w-xl mx-auto">Trusted investment platform. Fast withdraw via Binance.</p>
            <button onclick="login()" class="btn-gradient text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg transition">Start Earning</button>
        </div>
        <div class="max-w-6xl mx-auto p-4 pb-20">
            <h2 class="text-2xl font-bold text-center mb-8 text-gray-300">Our Plans</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6" id="public-pkg-list"></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden max-w-6xl mx-auto p-4 w-full pb-20">
        
        <!-- Balance & Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 mt-4">
            <!-- Balance Card -->
            <div class="glass p-6 rounded-xl border-t-4 border-green-500 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-gray-400 text-sm">My Balance</p>
                    <h3 class="text-4xl font-bold text-white">$<span id="balance">0.00</span></h3>
                    <button onclick="openWithdrawModal()" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-wallet"></i> Withdraw Money
                    </button>
                </div>
                <i class="fas fa-dollar-sign absolute -right-4 -bottom-4 text-9xl text-green-500/10 z-0"></i>
            </div>

            <!-- Active Plan Card -->
            <div class="glass p-6 rounded-xl border-t-4 border-blue-500">
                <p class="text-gray-400 text-sm">Active Status</p>
                <h3 class="text-xl font-bold text-blue-400" id="pkg-name">No Active Plans</h3>
            </div>
            
            <!-- Claims Left -->
            <div class="glass p-6 rounded-xl border-t-4 border-yellow-500 relative">
                <p class="text-gray-400 text-sm">Claims Left</p>
                <h3 class="text-2xl font-bold text-yellow-400"><span id="ads-left">0</span> <span class="text-sm text-gray-500">/ <span id="daily-limit">0</span></span></h3>
                
                <!-- 24H TIMER -->
                <div class="mt-2 bg-gray-800/50 rounded px-2 py-1 text-xs text-gray-400 inline-flex items-center gap-1">
                    <i class="fas fa-history text-yellow-500"></i> Next Reset: <span id="reset-timer" class="font-mono text-white font-bold">--:--</span>
                </div>
            </div>
        </div>

        <!-- REFERRAL SECTION -->
        <div class="glass p-6 rounded-xl mb-8 border border-purple-500/30 bg-gradient-to-r from-purple-900/20 to-blue-900/20">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-xl font-bold text-purple-400"><i class="fas fa-users mr-2"></i> Invite & Earn 20%</h3>
                    <p class="text-sm text-gray-400">Share your link. When they buy a package, you get <span class="text-white font-bold">20% commission</span> instantly!</p>
                </div>
                <div class="flex w-full md:w-auto bg-black/50 p-2 rounded border border-gray-600">
                    <input type="text" id="my-ref-link" readonly class="bg-transparent text-gray-300 text-sm flex-grow px-2 outline-none font-mono" value="Loading...">
                    <button id="ref-btn" onclick="copyRef()" class="bg-purple-600 hover:bg-purple-500 px-4 py-1 rounded text-xs font-bold transition-all duration-200">COPY</button>
                </div>
            </div>
        </div>

        <!-- Work Zone (CLAIM) -->
        <div id="work-zone" class="mb-10 hidden">
            <div class="glass p-6 rounded-xl bg-gray-800/50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Daily Income</h2>
                    <span class="text-xs bg-green-900 text-green-300 px-2 py-1 rounded">Next Reward: $<span id="earn-rate">0.00</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <h4 class="font-bold text-white">Claim Profit</h4>
                        <p class="text-xs text-gray-500">Click below to collect earnings.</p>
                    </div>
                    <button id="watch-btn" onclick="claimIncome()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-full font-bold shadow-lg animate-pulse">
                        <i class="fas fa-hand-holding-usd mr-2"></i> CLAIM
                    </button>
                </div>
            </div>
        </div>

        <!-- Packages -->
        <h2 class="text-xl font-bold mb-4 text-gray-300">Buy More Packages</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6" id="dashboard-pkg-list"></div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass bg-gray-900 p-6 rounded-xl w-full max-w-md relative border border-blue-500/30">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold text-white mb-2">Buy VIP $<span id="modal-price"></span></h3>
            <div class="bg-slate-800 p-4 rounded-lg mb-4 border border-slate-700">
                <p class="text-gray-400 text-xs mb-1">Binance Pay ID:</p>
                <div class="flex justify-between items-center bg-black p-3 rounded border border-gray-600">
                    <span class="font-mono text-yellow-500 font-bold text-lg tracking-wider" id="admin-binance">821397376</span>
                    <button onclick="copyId()" class="text-gray-400 hover:text-white"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <form onsubmit="submitDeposit(event)" class="space-y-4">
                <input type="text" id="trx-id" required placeholder="Enter TrxID" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white">
                <input type="file" id="ss-file" accept="image/*" required class="w-full text-sm text-gray-400 bg-gray-800 rounded p-1">
                <button type="submit" id="pay-btn" class="w-full btn-gradient py-3 rounded-lg font-bold text-white shadow-lg mt-2">Submit Payment</button>
                <p id="upload-status" class="text-center text-xs text-gray-500 mt-2"></p>
            </form>
        </div>
    </div>

    <!-- DYNAMIC SUCCESS MODAL (For Deposit/Withdraw) -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black/90 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass bg-gray-900 p-8 rounded-2xl w-full max-w-sm text-center success-anim border border-green-500/50">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-green-500/30">
                <i class="fas fa-check text-3xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2" id="success-title">Thank You!</h3>
            <p class="text-gray-300 mb-6" id="success-msg">Your request has been submitted.</p>
            <button onclick="closeSuccessModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-bold transition w-full">
                Okay, Got it
            </button>
        </div>
    </div>

    <!-- CONGRATULATIONS MODAL (For Claims) -->
    <div id="claim-modal" class="hidden fixed inset-0 bg-black/90 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass bg-gray-900 p-8 rounded-2xl w-full max-w-sm text-center success-anim border border-yellow-500/50">
            <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-yellow-500/30">
                <i class="fas fa-coins text-3xl text-black"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">Congratulations!</h3>
            <p class="text-gray-300 mb-6">You have successfully earned <span id="claim-amount" class="text-yellow-400 font-bold text-xl"></span></p>
            <button onclick="closeClaimModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-full font-bold transition w-full">
                Awesome!
            </button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass bg-gray-900 p-6 rounded-xl w-full max-w-md relative border border-green-500/30">
            <button onclick="closeWithdrawModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-2xl font-bold text-white mb-4"><i class="fas fa-wallet text-green-500"></i> Withdraw</h3>
            <form onsubmit="submitWithdraw(event)" class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Your Binance Pay ID / USDT Address</label>
                    <input type="text" id="w-binance-id" required placeholder="Enter your Binance ID" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Amount (Min $6)</label>
                    <input type="number" id="w-amount" required min="6" step="0.01" placeholder="6.00" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                </div>
                <button type="submit" id="w-btn" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold text-white shadow-lg">
                    Confirm Withdraw
                </button>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/95 z-[120] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass bg-gray-900 p-6 rounded-xl w-full max-w-2xl h-[80vh] flex flex-col relative">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h3 class="text-2xl font-bold text-white"><i class="fas fa-history text-blue-500"></i> History</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-6 custom-scrollbar">
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-2 tracking-wider">Package Purchases</h4>
                    <div id="deposit-history-list" class="space-y-2"><div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div></div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase mb-2 tracking-wider">Withdrawals</h4>
                    <div id="withdraw-history-list" class="space-y-2"><div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FLOATING SUPPORT BUTTON -->
    <a href="https://t.me/+R2eUEiEoNCc2ZGU1" target="_blank" class="fixed bottom-6 right-6 bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg shadow-blue-500/50 z-50 transition transform hover:scale-110 animate-bounce">
        <i class="fab fa-telegram-plane text-2xl"></i>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, increment, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWVUIW25hU7IuM0rHY69XchkEO-wM3_N4",
            authDomain: "spere-2e0be.firebaseapp.com",
            projectId: "spere-2e0be",
            storageBucket: "spere-2e0be.firebasestorage.app",
            messagingSenderId: "159090380576",
            appId: "1:159090380576:web:ce2f0fff445f81ca325145",
            measurementId: "G-KGFN47T5PJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const IMGBB_API_KEY = "acb81ea5938b150dfac714691e12bb10";
        const ADMIN_BINANCE_ID = "821397376";

        let currentUser = null;
        let currentBalance = 0;
        let selectedPkg = 0;
        let lastResetTime = 0;
        let currentClaimReward = 0;

        const packages = [
            { price: 5, ads: 5, rate: 0.10 },
            { price: 10, ads: 10, rate: 0.15 },
            { price: 20, ads: 15, rate: 0.20 },
            { price: 50, ads: 25, rate: 0.25 },
            { price: 100, ads: 40, rate: 0.30 }
        ];

        // --- 24 HOUR RESET TIMER (FIXED) ---
        function updateResetTimer() {
            if(!lastResetTime) { document.getElementById('reset-timer').innerText = "Ready"; return; }
            const now = Date.now();
            const resetTime = lastResetTime + (24 * 60 * 60 * 1000); // Changed to 24H
            const diff = resetTime - now;
            if(diff <= 0) { document.getElementById('reset-timer').innerText = "Now"; return; }
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('reset-timer').innerText = `${h}h ${m}m`;
        }
        setInterval(updateResetTimer, 60000);

        // --- REFERRAL ---
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        if(refCode) localStorage.setItem('sphere_ref', refCode);

        renderAllPackages();
        function renderAllPackages() {
            const getCard = (p, isDashboard) => `
                <div class="glass p-5 rounded-xl text-center relative overflow-hidden hover:border-blue-500 transition duration-300 group">
                    <div class="absolute top-0 right-0 bg-blue-600 text-xs px-2 py-1 rounded-bl-lg">VIP</div>
                    <h3 class="text-3xl font-bold text-white mb-1">$${p.price}</h3>
                    <ul class="text-sm text-gray-300 mb-4 space-y-2 text-left pl-4 border-t border-gray-700 pt-4">
                        <li><i class="fas fa-check-circle text-green-500 mr-2"></i> ${p.ads} Claims Daily</li>
                        <li><i class="fas fa-coins text-yellow-500 mr-2"></i> $${p.rate} Per Claim</li>
                        <li><i class="fas fa-wallet text-blue-400 mr-2"></i> Earn: <b>$${(p.ads * p.rate).toFixed(2)}</b>/Day</li>
                        <li class="text-gray-500 italic"><i class="fas fa-clock mr-2"></i> 30 Days Validity</li>
                    </ul>
                    <button onclick="${isDashboard ? `openModal(${p.price})` : 'login()'}" 
                        class="w-full py-2 rounded-lg font-bold transition ${isDashboard ? 'btn-gradient text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}">
                        ${isDashboard ? 'Buy Now' : 'Login to Buy'}
                    </button>
                </div>
            `;
            document.getElementById('public-pkg-list').innerHTML = packages.map(p => getCard(p, false)).join('');
            document.getElementById('dashboard-pkg-list').innerHTML = packages.map(p => getCard(p, true)).join('');
        }

        window.login = () => {
            signInWithPopup(auth, provider).then(async (result) => {
                const user = result.user;
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    const referrer = localStorage.getItem('sphere_ref');
                    await setDoc(userRef, {
                        name: user.displayName, email: user.email, balance: 0,
                        activePkg: null, ownedPlans: [], claimValues: [], adsLeft: 0, dailyLimit: 0, rate: 0,
                        lastResetTime: Date.now() - (25 * 3600000), // Reset 25h ago for instant start
                        referredBy: referrer || null
                    });
                }
            }).catch(e => alert(e.message));
        };
        
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('username').innerText = user.displayName.split(' ')[0];
                const refLink = `${window.location.origin}/?ref=${user.uid}`;
                document.getElementById('my-ref-link').value = refLink;
                loadUserData();
            }
        });

        window.copyRef = () => {
            const copyText = document.getElementById("my-ref-link");
            const btn = document.getElementById("ref-btn");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            btn.innerText = "COPIED!";
            btn.classList.add("copy-success");
            setTimeout(() => { btn.innerText = "COPY"; btn.classList.remove("copy-success"); }, 2000);
        }

        function loadUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            onSnapshot(userRef, (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    currentBalance = data.balance || 0;
                    lastResetTime = data.lastResetTime || 0; 
                    updateResetTimer(); 

                    if(data.planExpiresAt && Date.now() > data.planExpiresAt) {
                        document.getElementById('pkg-name').innerText = "Plan Expired";
                        document.getElementById('pkg-name').classList.replace('text-blue-400', 'text-red-500');
                        document.getElementById('work-zone').classList.add('hidden');
                        return;
                    }

                    // 24 HOUR RESET CHECK
                    const twentyFourHours = 24 * 60 * 60 * 1000;
                    if(Date.now() > (lastResetTime + twentyFourHours)) {
                        updateDoc(userRef, { 
                            adsLeft: data.dailyLimit, 
                            lastResetTime: Date.now() 
                        });
                    }

                    document.getElementById('balance').innerText = currentBalance.toFixed(2);
                    
                    let planText = "No Active Plans";
                    if(data.ownedPlans && Array.isArray(data.ownedPlans) && data.ownedPlans.length > 0) {
                        planText = `You purchased ${data.ownedPlans.length} plan${data.ownedPlans.length > 1 ? 's' : ''}`;
                    } else if (data.activePkg) {
                        planText = "You purchased 1 plan";
                    }
                    document.getElementById('pkg-name').innerText = planText;

                    document.getElementById('ads-left').innerText = data.adsLeft || 0;
                    document.getElementById('daily-limit').innerText = data.dailyLimit || 0;

                    let nextReward = 0;
                    if(data.claimValues && data.adsLeft > 0 && data.dailyLimit > 0) {
                        const index = data.dailyLimit - data.adsLeft;
                        if(index >= 0 && index < data.claimValues.length) {
                            nextReward = data.claimValues[index];
                        }
                    } else {
                        nextReward = data.rate || 0;
                    }
                    currentClaimReward = nextReward; 
                    document.getElementById('earn-rate').innerText = nextReward.toFixed(2); 

                    const workZone = document.getElementById('work-zone');
                    const watchBtn = document.getElementById('watch-btn');
                    if (data.activePkg) {
                        workZone.classList.remove('hidden');
                        if(data.adsLeft <= 0) {
                            watchBtn.innerText = "Wait for Reset";
                            watchBtn.disabled = true;
                            watchBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            watchBtn.classList.remove('animate-pulse');
                        } else {
                            watchBtn.innerText = "CLAIM";
                            watchBtn.disabled = false;
                            watchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            watchBtn.classList.add('animate-pulse');
                        }
                    }
                }
            });
        }

        window.claimIncome = async () => {
            const btn = document.getElementById('watch-btn');
            btn.disabled = true;
            btn.innerText = "Claiming...";
            
            setTimeout(async () => {
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, {
                        balance: increment(currentClaimReward),
                        adsLeft: increment(-1)
                    });
                    document.getElementById('claim-amount').innerText = `$${currentClaimReward.toFixed(2)}`;
                    document.getElementById('claim-modal').classList.remove('hidden');
                } catch(e) { 
                    console.error(e);
                    alert("Error claiming reward");
                    btn.disabled = false;
                    btn.innerText = "Try Again";
                }
            }, 800);
        };

        // [Keeping Modals logic as is...]
        window.closeClaimModal = () => document.getElementById('claim-modal').classList.add('hidden');
        window.closeSuccessModal = () => document.getElementById('success-modal').classList.add('hidden');
        window.closeWithdrawModal = () => document.getElementById('withdraw-modal').classList.add('hidden');
        window.closeModal = () => document.getElementById('payment-modal').classList.add('hidden');
        window.closeHistoryModal = () => document.getElementById('history-modal').classList.add('hidden');

        window.openWithdrawModal = () => document.getElementById('withdraw-modal').classList.remove('hidden');
        
        window.openHistoryModal = async () => {
            if (!currentUser) return alert("Please login first");
            document.getElementById('history-modal').classList.remove('hidden');
            const depList = document.getElementById('deposit-history-list');
            const withList = document.getElementById('withdraw-history-list');
            depList.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>';
            withList.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>';

            try {
                const qDep = query(collection(db, "deposits"), where("uid", "==", currentUser.uid));
                const depSnap = await getDocs(qDep);
                let deps = [];
                depSnap.forEach(d => deps.push(d.data()));
                deps.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if (deps.length === 0) {
                    depList.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">No purchases found.</p>';
                } else {
                    depList.innerHTML = '';
                    deps.forEach(d => {
                        const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                        const statusColor = d.status === 'approved' ? 'text-green-400' : 'text-yellow-500';
                        const icon = d.status === 'approved' ? 'fa-check-circle' : 'fa-clock';
                        depList.innerHTML += `
                            <div class="bg-gray-800/50 border border-gray-700 p-3 rounded-lg flex justify-between items-center">
                                <div><p class="font-bold text-white">VIP $${d.pkgPrice}</p><p class="text-xs text-gray-500">${date}</p></div>
                                <div class="text-right"><span class="${statusColor} text-sm font-bold capitalize"><i class="fas ${icon} mr-1"></i> ${d.status}</span></div>
                            </div>`;
                    });
                }

                const qWith = query(collection(db, "withdrawals"), where("uid", "==", currentUser.uid));
                const withSnap = await getDocs(qWith);
                let withs = [];
                withSnap.forEach(d => withs.push(d.data()));
                withs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if (withs.length === 0) {
                    withList.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">No withdrawals yet.</p>';
                } else {
                    withList.innerHTML = '';
                    withs.forEach(w => {
                        const date = w.timestamp ? new Date(w.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                        const statusColor = w.status === 'paid' ? 'text-green-400' : 'text-yellow-500';
                        const icon = w.status === 'paid' ? 'fa-check-circle' : 'fa-clock';
                        withList.innerHTML += `
                            <div class="bg-gray-800/50 border border-gray-700 p-3 rounded-lg flex justify-between items-center">
                                <div><p class="font-bold text-white">Withdraw $${w.amount}</p><p class="text-xs text-gray-500">${date}</p></div>
                                <div class="text-right"><span class="${statusColor} text-sm font-bold capitalize"><i class="fas ${icon} mr-1"></i> ${w.status === 'pending' ? 'Pending' : 'Paid'}</span></div>
                            </div>`;
                    });
                }
            } catch (e) {
                console.error("History Error:", e);
                depList.innerHTML = `<p class="text-red-400 text-center text-xs">Error: ${e.message}</p>`;
                withList.innerHTML = `<p class="text-red-400 text-center text-xs">Error: ${e.message}</p>`;
            }
        };

        window.submitWithdraw = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('w-amount').value);
            const binanceId = document.getElementById('w-binance-id').value;
            const btn = document.getElementById('w-btn');
            if(amount < 6) return alert("Minimum withdrawal is $6!");
            if(amount > currentBalance) return alert("Insufficient Balance!");
            btn.innerText = "Processing...";
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { balance: increment(-amount) });
                await addDoc(collection(db, "withdrawals"), { uid: currentUser.uid, email: currentUser.email, amount: amount, binanceId: binanceId, status: "pending", timestamp: new Date() });
                closeWithdrawModal();
                document.getElementById('success-title').innerText = "Withdrawal Pending";
                document.getElementById('success-msg').innerText = "Your request has been sent to admin.";
                document.getElementById('success-modal').classList.remove('hidden');
                document.getElementById('w-amount').value = "";
            } catch(err) { alert("Error: " + err.message); } 
            finally { btn.innerText = "Confirm Withdraw"; btn.disabled = false; }
        };

        window.openModal = (price) => {
            selectedPkg = price;
            document.getElementById('modal-price').innerText = price;
            document.getElementById('admin-binance').innerText = ADMIN_BINANCE_ID;
            document.getElementById('payment-modal').classList.remove('hidden');
        };
        window.copyId = () => { navigator.clipboard.writeText(ADMIN_BINANCE_ID); alert("ID Copied!"); };

        window.submitDeposit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('pay-btn');
            const status = document.getElementById('upload-status');
            const oldText = btn.innerText;
            const file = document.getElementById('ss-file').files[0];
            const trxId = document.getElementById('trx-id').value;
            if (!currentUser || !file) return alert("Invalid Request");
            btn.innerText = "Processing...";
            btn.disabled = true;
            status.innerText = "Uploading Proof...";
            try {
                const formData = new FormData();
                formData.append("image", file);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const result = await response.json();
                if (!result.success) throw new Error("Image Upload Failed");
                await addDoc(collection(db, "deposits"), { uid: currentUser.uid, email: currentUser.email, pkgPrice: selectedPkg, trxId, proofUrl: result.data.url, status: "pending", timestamp: new Date() });
                closeModal();
                document.getElementById('success-title').innerText = "Purchase Pending";
                document.getElementById('success-msg').innerText = "Your payment proof submitted.";
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (err) { alert(err.message); } 
            finally { btn.innerText = oldText; btn.disabled = false; status.innerText = ""; }
        };
    </script>
</body>
</html>